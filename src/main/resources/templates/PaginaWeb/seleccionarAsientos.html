<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CinemaNights- Selecci√≥n de Asientos</title>
 
  <script src="https://cdn.tailwindcss.com"></script>
      <link rel="stylesheet" th:href="@{/css/PaginaWeb.css}">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
      <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
	  <link rel="stylesheet" th:href="@{/css/asientos.css}">
     
    </head>
    <body class="bg-white text-white font-[Poppins]">
    	
  	<!-- üåü NAVBAR -->
  	<nav class="bg-gray-900 text-white font-[Poppins] p-4 flex justify-between items-center shadow-lg">
  	  <!-- üé¨ Logo -->
  	  <h1 class="text-2xl font-bold text-red-500 tracking-wide">üé¨ CinemaNights</h1>

  	  <!-- üìÑ Enlaces principales -->
  	  <ul class="flex space-x-6 font-semibold text-sm uppercase tracking-wide">
  	    <li><a th:href="@{/PaginaWeb/index}" class="hover:text-red-400 transition">Inicio</a></li>
  	    <li><a th:href="@{/cartelera}" class="hover:text-red-400 transition">Pel√≠culas</a></li>
  	    <li><a th:href="@{/nosotros}" class="hover:text-red-400 transition">Nosotros</a></li>
  	    <li><a th:href="@{/contacto}" class="hover:text-red-400 transition">Contacto</a></li>
  	  </ul>

  	  <!-- üîê Autenticaci√≥n -->
  	  <div class="flex items-center gap-4">
  	    <!-- Usuario autenticado -->
  	    <div sec:authorize="isAuthenticated()" class="flex items-center gap-3">
  	      <span class="text-sm">üëã Bienvenido, <strong th:text="${nombreCom}" class="text-red-400"></strong></span>
  	      <a th:href="@{/logout}"
  	         class="bg-white text-black px-3 py-1 rounded-md font-semibold hover:bg-gray-200 transition text-sm">
  	         Cerrar sesi√≥n
  	      </a>
  	    </div>

  	    <!-- Usuario NO autenticado -->
  	    <div sec:authorize="!isAuthenticated()" class="flex gap-3">
  	      <a th:href="@{/login}" 
  	         class="px-4 py-2 rounded-md font-semibold bg-white text-black hover:bg-gray-200 transition text-sm">
  	         Iniciar sesi√≥n
  	      </a>
  	      <a th:href="@{/registro}" 
  	         class="px-4 py-2 rounded-md font-semibold bg-red-600 text-white hover:bg-red-700 transition text-sm">
  	         Registrarse
  	      </a>
  	    </div>
  	  </div>
  	</nav>


  <!-- üéüÔ∏è CONTENIDO PRINCIPAL -->
  <main class="container mx-auto mt-20 mb-20 text-center">
    <h1 class="text-4xl font-extrabold text-red-600 uppercase tracking-wide mb-2">Selecciona tus Asientos</h1>
    <p class="text-gray-600" th:text="'Funci√≥n: ' + ${funcion.pelicula.titulo} + ' | Sala: ' + ${funcion.sala.nombreSala}"></p>
    <p class="text-gray-500 mb-8" th:text="'Fecha: ' + ${#temporals.format(funcion.fechaFuncion, 'dd/MM/yyyy')} + ' | Hora: ' + ${funcion.horaInicio}"></p>

    <!-- üé• PANTALLA CURVA -->
    <div class="w-3/4 mx-auto h-5 bg-gradient-to-r from-gray-300 via-white to-gray-300 rounded-t-full shadow-inner"></div>
    <p class="text-center text-gray-600 text-sm mt-2 uppercase tracking-wide">Pantalla</p>

    <!-- üé¨ MAPA DE ASIENTOS -->
    <div class="mt-8 flex flex-col items-center space-y-10">

      <!-- Zona Superior -->
      <div class="zona">
        <h5 class="text-lg font-semibold text-gray-700 mb-3 uppercase">Zona Superior</h5>
        <div class="grid grid-cols-10 gap-3 justify-center">
          <div th:each="asiento : ${zonaSuperior}"
               th:class="'asiento ' + (${asiento.estado} == 'RESERVADO' ? 'ocupado' : 'libre')"
               th:data-id="${asiento.idFuncionAsiento}"
               th:title="${asiento.asiento.codigoAsiento}">
            <span th:text="${asiento.asiento.codigoAsiento}"></span>
          </div>
        </div>
      </div>

      <!-- Zona Media -->
      <div class="zona">
        <h5 class="text-lg font-semibold text-gray-700 mb-3 uppercase">Zona Media</h5>
        <div class="grid grid-cols-10 gap-3 justify-center">
          <div th:each="asiento : ${zonaMedia}"
               th:class="'asiento ' + (${asiento.estado} == 'RESERVADO' ? 'ocupado' : 'libre')"
               th:data-id="${asiento.idFuncionAsiento}"
               th:title="${asiento.asiento.codigoAsiento}">
            <span th:text="${asiento.asiento.codigoAsiento}"></span>
          </div>
        </div>
      </div>

      <!-- Zona Inferior -->
      <div class="zona">
        <h5 class="text-lg font-semibold text-gray-700 mb-3 uppercase">Zona Inferior</h5>
        <div class="grid grid-cols-10 gap-3 justify-center">
          <div th:each="asiento : ${zonaInferior}"
               th:class="'asiento ' + (${asiento.estado} == 'RESERVADO' ? 'ocupado' : 'libre')"
               th:data-id="${asiento.idFuncionAsiento}"
               th:title="${asiento.asiento.codigoAsiento}">
            <span th:text="${asiento.asiento.codigoAsiento}"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- üé® LEYENDA -->
    <div class="flex justify-center gap-6 mt-8 text-sm text-gray-700">
      <div class="flex items-center gap-2"><div class="w-5 h-5 bg-blue-500 rounded"></div> <span>Disponible</span></div>
      <div class="flex items-center gap-2"><div class="w-5 h-5 bg-red-600 rounded"></div> <span>Ocupado</span></div>
      <div class="flex items-center gap-2"><div class="w-5 h-5 bg-green-600 rounded"></div> <span>Seleccionado</span></div>
      <div class="flex items-center gap-2"><div class="w-5 h-5 bg-yellow-500 rounded"></div> <span>VIP</span></div>
    </div>

    <!-- üé´ BOT√ìN -->
    <button id="btnContinuar"
      class="mt-10 bg-red-600 hover:bg-red-700 text-white font-semibold px-8 py-3 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">
      <i class="bi bi-ticket-detailed mr-2"></i>Continuar Reserva
    </button>
  </main>

  <!-- FORMULARIO OCULTO -->
  <form id="formReserva" th:action="@{/reserva/guardar}" method="post">
    <input type="hidden" name="idFuncion" th:value="${funcion.idFuncion}">
    <input type="hidden" name="asientosSeleccionados" id="asientosSeleccionados">
    <input type="hidden" name="metodoPago" id="metodoPago">
  </form>

  <!-- ‚ö´ FOOTER -->
  <footer class="bg-black text-gray-300 pt-10 pb-6 mt-16">
    <div class="container mx-auto px-4">
      <div class="flex flex-col md:flex-row justify-between items-center md:items-start gap-8">
        <div class="text-center md:text-left">
          <h2 class="text-2xl font-bold text-red-500 mb-2">üé¨ CinemaNights</h2>
          <p class="text-gray-400 max-w-sm">La mejor experiencia de cine, con promociones y preventas exclusivas.</p>
        </div>
        <div class="text-center md:text-left">
          <h3 class="font-semibold mb-2">Enlaces</h3>
          <ul>
            <li><a th:href="@{/PaginaWeb/index}" class="hover:text-red-500 transition">Inicio</a></li>
            <li><a th:href="@{/cartelera}" class="hover:text-red-500 transition">Pel√≠culas</a></li>
            <li><a th:href="@{/nosotros}" class="hover:text-red-500 transition">Nosotros</a></li>
            <li><a th:href="@{/contacto}" class="hover:text-red-500 transition">Contacto</a></li>
          </ul>
        </div>
        <div class="text-center md:text-left">
          <h3 class="font-semibold mb-2">S√≠guenos</h3>
          <div class="flex gap-4 justify-center md:justify-start">
            <a href="#" class="text-gray-400 hover:text-red-500 text-xl"><i class="bi bi-facebook"></i></a>
            <a href="#" class="text-gray-400 hover:text-red-500 text-xl"><i class="bi bi-instagram"></i></a>
            <a href="#" class="text-gray-400 hover:text-red-500 text-xl"><i class="bi bi-twitter"></i></a>
            <a href="#" class="text-gray-400 hover:text-red-500 text-xl"><i class="bi bi-youtube"></i></a>
          </div>
        </div>
        <div class="text-center md:text-left">
          <h3 class="font-semibold mb-2">Contacto</h3>
          <p class="text-gray-400"><i class="bi bi-geo-alt-fill me-1"></i> Av. CinemaNights 123, Lima, Per√∫</p>
          <p class="text-gray-400"><i class="bi bi-telephone-fill me-1"></i> +51 987 654 321</p>
          <p class="text-gray-400"><i class="bi bi-envelope-fill me-1"></i> info@cinegalaxy.com</p>
        </div>
      </div>
      <hr class="my-6 border-gray-700">
      <p class="text-center text-gray-500 text-sm">&copy; 2025 CinemaNights. Todos los derechos reservados.</p>
    </div>
  </footer>

  <!-- üé® ESTILOS ASIENTOS -->
  <style>
    .asiento {
      @apply w-10 h-10 flex justify-center items-end rounded-md relative cursor-pointer transition-transform duration-200 text-xs font-semibold text-white select-none;
    }
    .asiento::after {
      content: '';
      @apply absolute top-1 left-1 right-1 h-2 bg-white/20 rounded-t-md;
    }
    .asiento.libre { @apply bg-gradient-to-b from-blue-500 to-blue-800 shadow-[0_3px_0_#1e3a8a] hover:scale-110; }
    .asiento.ocupado { @apply bg-gradient-to-b from-red-400 to-red-700 opacity-70 cursor-not-allowed; }
    .asiento.seleccionado { @apply bg-gradient-to-b from-green-400 to-green-700 shadow-[0_3px_0_#14532d] -translate-y-1; }
    .asiento.vip { @apply bg-gradient-to-b from-yellow-400 to-yellow-600 ring-2 ring-yellow-500; }
  </style>

  <!-- ‚öôÔ∏è SCRIPT ORIGINAL (NO TOCADO) -->
  <script th:inline="javascript">
    var isAuthenticated = /*[[${#authorization.expr('isAuthenticated()')}]]*/ false;
    const asientos = document.querySelectorAll('.asiento.libre');
    const btnContinuar = document.getElementById('btnContinuar');
    let seleccionados = [];

    asientos.forEach(a => {
      a.addEventListener('click', () => {
        const id = a.getAttribute('data-id');
        if (a.classList.contains('seleccionado')) {
          a.classList.remove('seleccionado');
          seleccionados = seleccionados.filter(s => s !== id);
        } else {
          a.classList.add('seleccionado');
          seleccionados.push(id);
        }
      });
    });

    btnContinuar.addEventListener('click', () => {
      if (seleccionados.length === 0) {
        Swal.fire('Atenci√≥n', 'Debes seleccionar al menos un asiento.', 'warning');
        return;
      }
      if (!isAuthenticated) {
        Swal.fire({
          title: '¬°Debes iniciar sesi√≥n!',
          text: 'Para continuar con la reserva, inicia sesi√≥n o reg√≠strate.',
          icon: 'info',
          showCancelButton: true,
          confirmButtonText: 'Iniciar Sesi√≥n',
          cancelButtonText: 'Registrarse'
        }).then((result) => {
          if (result.isConfirmed) window.location.href = '/login';
          else if (result.dismiss === Swal.DismissReason.cancel) window.location.href = '/register';
        });
        return;
      }
      elegirMetodoPago();
    });

    function elegirMetodoPago() {
      Swal.fire({
        title: 'M√©todo de Pago',
        html: `
          <div class="text-start">
            <label><input type="radio" name="pago" value="TARJETA"> Tarjeta (Pago inmediato)</label><br>
            <label><input type="radio" name="pago" value="CONTRA_ENTREGA"> Contra Entrega (Pendiente)</label>
          </div>
        `,
        confirmButtonText: 'Continuar',
        preConfirm: () => {
          const metodo = document.querySelector('input[name="pago"]:checked');
          if (!metodo) {
            Swal.showValidationMessage('Selecciona un m√©todo de pago');
            return false;
          }
          return metodo.value;
        }
      }).then(result => {
        if (!result.isConfirmed) return;
        const metodo = result.value;
        if (metodo.toUpperCase() === 'TARJETA') pagoTarjeta();
        else confirmContraEntrega();
      });
    }

    function pagoTarjeta() {
      Swal.fire({
        title: 'Pago con Tarjeta üí≥',
        html: `
          <input type="text" id="numTarjeta" class="swal2-input" placeholder="N√∫mero de tarjeta">
          <input type="text" id="vencimiento" class="swal2-input" placeholder="MM/AA">
          <input type="text" id="cvv" class="swal2-input" placeholder="CVV">
        `,
        confirmButtonText: 'Pagar',
        focusConfirm: false,
        didOpen: () => {
          const numTarjeta = document.getElementById('numTarjeta');
          numTarjeta.addEventListener('input', (e) => {
            let val = e.target.value.replace(/\D/g, '').slice(0, 16);
            val = val.match(/.{1,4}/g)?.join(' ') || val;
            e.target.value = val;
          });
        },
        preConfirm: () => {
          const num = document.getElementById('numTarjeta').value.replace(/\s+/g, '');
          const venc = document.getElementById('vencimiento').value.trim();
          const cvv = document.getElementById('cvv').value.trim();
          if (!num || !venc || !cvv) {
            Swal.showValidationMessage('Completa todos los campos de la tarjeta');
            return false;
          }
          if (num.length !== 16 || isNaN(num)) {
            Swal.showValidationMessage('N√∫mero de tarjeta inv√°lido. Debe tener 16 d√≠gitos.');
            return false;
          }
          if (!/^\d{2}\/\d{2}$/.test(venc)) {
            Swal.showValidationMessage('Fecha inv√°lida. Usa MM/AA');
            return false;
          }
          if (!/^\d{3}$/.test(cvv)) {
            Swal.showValidationMessage('CVV inv√°lido (3 d√≠gitos)');
            return false;
          }
          return { num, venc, cvv };
        }
      }).then(pago => {
        if (pago.isConfirmed) procesarReserva('TARJETA', 'Pagado');
      });
    }

    function confirmContraEntrega() {
      Swal.fire({
        title: 'Confirmar reserva ü™ë',
        text: 'Tu reserva se registrar√° como pendiente de pago.',
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Confirmar',
        cancelButtonText: 'Cancelar'
      }).then(confirm => {
        if (confirm.isConfirmed) procesarReserva('CONTRA_ENTREGA', 'Pendiente');
      });
    }

    function procesarReserva(metodo, estado) {
      document.getElementById("asientosSeleccionados").value = seleccionados.join(",");
      document.getElementById("metodoPago").value = metodo.toUpperCase(); 
      document.getElementById("formReserva").submit();
      Swal.fire({ icon: 'success', title: 'üéüÔ∏è Ticket reservado correctamente', text: `Estado: ${estado}`, confirmButtonText: 'OK' });
    }
  </script>
  <!-- ‚ö° SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>
</html>
